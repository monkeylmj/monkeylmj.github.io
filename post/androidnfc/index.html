<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>Android NFCå¼€å‘å…¥é—¨ | çŒ´å­å…¬å›­</title>
<meta name="description" content="åšæŒæ¯”å®Œç¾æ›´é‡è¦">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://monkeylmj.github.io//favicon.ico?v=1596276237496">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://monkeylmj.github.io//styles/main.css">


  
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css" />
  

  


<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>

<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />



  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://monkeylmj.github.io/">
        <img src="https://monkeylmj.github.io//images/avatar.png?v=1596276237496" class="site-logo">
        <h1 class="site-title">çŒ´å­å…¬å›­</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="https://monkeylmj.github.io/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="https://monkeylmj.github.io//archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="https://monkeylmj.github.io//tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="https://monkeylmj.github.io//post/about/" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      åšæŒæ¯”å®Œç¾æ›´é‡è¦
    </div>
    <div class="site-footer">
      Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | <a class="rss" href="https://monkeylmj.github.io//atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">Android NFCå¼€å‘å…¥é—¨</h2>
            <div class="post-date">2017-02-28</div>
            
            <div class="post-content">
              <p>æ€»ç»“ä¸€ä¸‹Androidä¸­NFCå¼€å‘ç›¸å…³çš„çŸ¥è¯†ç‚¹ã€‚</p>
<!-- more -->
<h2 id="nfcçš„å‡ ä¸ªæ¦‚å¿µ">NFCçš„å‡ ä¸ªæ¦‚å¿µ</h2>
<ul>
<li>
<p><strong>æ¥è§¦å¼ICå¡</strong> ä¾‹å¦‚æ‰‹æœºSIMå¡ã€é‡‘èICå¡ã€‚</p>
</li>
<li>
<p><strong>éæ¥è§¦å¼ICå¡</strong> åˆç§°å°„é¢‘å¡ï¼Œå°†æ— çº¿å°„é¢‘è¯†åˆ«æŠ€æœ¯å’ŒICå¡ç»“åˆèµ·æ¥ï¼Œå…æ¥è§¦ã€‚</p>
</li>
<li>
<p><strong>RFID</strong> æ— çº¿å°„é¢‘è¯†åˆ«ï¼Œä¸€ç§æ— çº¿é€šè®¯æŠ€æœ¯ã€‚</p>
<p>åŸºæœ¬åŸç†ï¼šé˜…è¯»å™¨å°†ç”µä¿¡å·è½¬æ¢ä¸ºæ— çº¿ç”µä¿¡å·ï¼ˆç”µç£æ³¢çš„ä¸€ä¸ªé¢‘å¸¦ï¼‰å‘ç»™æ ‡ç­¾ï¼Œæ ‡ç­¾ä½¿ç”¨æ¥æ”¶åˆ°çš„æ— çº¿ç”µæ³¢èƒ½é‡ä¾›ç”µï¼Œç„¶åå°†å­˜å‚¨åœ¨è‡ªèº«æ•°æ®ä»¥æ— çº¿ç”µä¿¡å·çš„å½¢å¼åº”ç­”ç»™é˜…è¯»å™¨ï¼Œä»¥è¯»å–åˆ°æ ‡ç­¾ä¸­çš„æ•°æ®ã€‚</p>
</li>
<li>
<p><strong>NFC</strong>ï¼ˆNear Field Communicationï¼‰ çŸ­è·ç¦»æ— çº¿é€šè®¯æŠ€æœ¯ï¼ŒåŸºäºRFIDï¼Œä¸€èˆ¬åœ¨10cmä¹‹å†…ä½¿ç”¨13.56MHzé¢‘ç‡é€šè®¯</p>
</li>
</ul>
<hr>
<h2 id="androidå¦‚ä½•ä½¿ç”¨nfc">Androidå¦‚ä½•ä½¿ç”¨NFC</h2>
<h3 id="æƒé™å£°æ˜">æƒé™å£°æ˜</h3>
<p>åœ¨AndroidManifest.xmlä¸­å¦‚ä¸‹ç”³è¯·NFCæƒé™:</p>
<pre><code class="language-xml">&lt;uses-permission android:name=&quot;android.permission.NFC&quot; /&gt;
</code></pre>
<p>æ·»åŠ ä¸‹é¢ä¸€è¡Œï¼Œä¿è¯åœ¨GooglePlayå•†åº—æ­¤åº”ç”¨åªæ˜¾ç¤ºç»™å¸¦NFCç¡¬ä»¶çš„è®¾å¤‡</p>
<pre><code class="language-xml">&lt;uses-feature android:name=&quot;android.hardware.nfc&quot; android:required=&quot;true&quot; /&gt;
</code></pre>
<p>åœ¨ä»£ç ä¸­åŠ¨æ€åˆ¤æ–­è®¾å¤‡æ˜¯å¦æ”¯æŒNFCï¼š</p>
<pre><code class="language-java">if(NfcAdapter.getDefaultAdapter() == null){
  Log.v(&quot;monkey&quot;,&quot;è®¾å¤‡ä¸æ”¯æŒNFC.&quot;);
}
</code></pre>
<h3 id="nfcçš„ä¸‰ç§æ¨¡å¼">NFCçš„ä¸‰ç§æ¨¡å¼</h3>
<ol>
<li><strong>Reader/writer mode</strong> é€šè¿‡Androidè®¾å¤‡å¯¹NFCæ ‡ç­¾è¿›è¡Œè¯»å†™æ•°æ®æ“ä½œã€‚</li>
<li><strong>P2P mode</strong> NFCè®¾å¤‡ä¹‹é—´äº¤æ¢æ•°æ®ï¼ŒAndroidBeamä½¿ç”¨è¿™ç§æ¨¡å¼ã€‚</li>
<li><strong>Card emulation mode</strong> NFCè®¾å¤‡æ¨¡æ‹ŸæˆNFCæ ‡ç­¾ã€‚</li>
</ol>
<h2 id="readerwrite-mode">Reader/write mode</h2>
<p>Androidé€šè¿‡æ ‡ç­¾åˆ†å‘ç³»ç»Ÿåˆ†æå‘ç°çš„NFCæ ‡ç­¾ï¼Œå°è£…æˆå¯¹åº”çš„Intentå‘ç»™Androidä¸Šå±‚è¿›è¡Œå¯¹åº”çš„å¤„ç†ã€‚</p>
<p>Androidä¸­å…³äºNFCæœ‰ä¸‰ç§ç±»å‹çš„Actionï¼ˆä¼˜å…ˆçº§ç”±é«˜åˆ°ä½ï¼‰ï¼š</p>
<p><code>ACTION_NDEF_DISCOVERED</code> <code>ACTION_TECH_DISCOVERED</code> <code>ACTION_TAG_DISCOVERED</code></p>
<p>è¿™é‡Œçš„<em>ä¼˜å…ˆçº§</em>å¯ä»¥é€šè¿‡æ ‡ç­¾åˆ†å‘ç³»ç»Ÿçš„æœºåˆ¶æ¥è§£é‡Š:</p>
<ol>
<li>å¦‚æœä¸€ä¸ªåŒ…å«<strong>NDEF</strong>æ ¼å¼æ•°æ®çš„NFCæ ‡ç­¾è¢«å‘ç°ï¼ŒAndroidä¼˜å…ˆå‘é€å¸¦<code>ACTION_NDEF_DISCOVERED</code>actionçš„Intentã€‚</li>
<li>å¦‚æœæ²¡æœ‰Activityå¤„ç†<code>ACTION_NDEF_DISCOVERED</code>ç±»å‹çš„intent <em>æˆ–è€…</em> NFCæ ‡ç­¾ä¸åŒ…å«<strong>NDEF</strong>æ ¼å¼çš„æ•°æ®ï¼ˆä½¿ç”¨äº†å…¶ä»–å·²çŸ¥æŠ€æœ¯ï¼‰<em>æˆ–è€…</em> <strong>NDEF</strong>æ ¼å¼çš„æ ‡ç­¾ä¸èƒ½è¢«æ ‡ç­¾åˆ†å‘ç³»ç»Ÿæ˜ å°„æˆæ­£ç¡®çš„Intentï¼Œåˆ™ä¼šå‘é€ä¼˜å…ˆçº§è¾ƒä½çš„<code>ACTION_TECH_DISCOVERED</code>intentæ¥å°è¯•å¯åŠ¨Activityï¼ˆä¸ä¼šå‘é€<code>ACTION_NDEF_DISCOVERED</code>ï¼‰ã€‚</li>
<li>å¦‚æœä»ç„¶æ²¡æœ‰Activityå“åº”ä¸Šè¿°ä¸¤ä¸ªActionï¼Œåˆ™ç³»ç»Ÿä¼šå‘é€ä¼˜å…ˆçº§æœ€ä½çš„<code>ACTION_TAG_DISCOVERED</code>çš„Intentã€‚</li>
</ol>
<p>å›¾ä¸ºæ ‡ç­¾åˆ†å‘ç³»ç»Ÿï¼š</p>
<figure data-type="image" tabindex="1"><img src="https://i.loli.net/2019/03/02/5c7a184962704.png" alt="" loading="lazy"></figure>
<h3 id="nfcæ•°æ®æ ¼å¼">NFCæ•°æ®æ ¼å¼</h3>
<p>NFCçš„æ•°æ®æ ¼å¼å¯ä»¥åˆ†ä¸ºNDEFå’ŒéNDEFä¸¤ç§ã€‚<strong>NDEF</strong>æ˜¯NFC Forumå®šä¹‰çš„ä¸€ç§æ ‡å‡†æ ¼å¼ï¼Œåœ¨Androidä¸­å¾—åˆ°æœ€å¤§èŒƒå›´çš„æ”¯æŒï¼Œæ˜¯Androidæœ€æ¨èä½¿ç”¨çš„æ ¼å¼ã€‚</p>
<ul>
<li>
<p><strong>NDEFæ•°æ®</strong>åœ¨AndroidSDKä¸­è¢«å°è£…æˆä¸€ä¸ªåŒ…å«å¤šä¸ª<strong>NdefRecord</strong>çš„<strong>NdefMessage</strong>ï¼Œ<strong>android.nfc.tech.Ndef</strong>ç±»å°è£…äº†å„ç§ä¾¿æ·çš„è¯»å†™æ•°æ®çš„æ“ä½œã€‚</p>
<p>å‰é¢è¯´è¿‡å½“Androidè®¾å¤‡å‘ç°NDEFæ ¼å¼çš„æ ‡ç­¾ä¹‹åä¼šå‘å‡º<code>ACTION_NDEF_DISCOVERED</code>ç±»å‹çš„Intentã€‚é€šå¸¸åœ¨intentä¸­è¿˜ä¼šå¸¦ä¸Šæ›´åŠ å…·ä½“çš„mime type &amp; URIç­‰æ•°æ®ï¼Œä»¥ä¾¿ç­›é€‰æ›´åŠ å…·ä½“çš„Activityæ¥è¿›è¡Œå¤„ç†ï¼ˆè¿™ä¸ªæ˜¯Androidæ¨èä½¿ç”¨è¿™ä¸ªæ ¼å¼çš„åŸå› ä¹‹ä¸€ï¼‰ã€‚ä¸‹é¢å°±æ¥è¯´è¯´ï¼ŒNDEFå…·ä½“çš„æ•°æ®æ ¼å¼ä»¥åŠAndroidå¦‚ä½•åˆ†æNDEFæ•°æ®æ¥ç”Ÿæˆå¯¹åº”çš„Intentã€‚</p>
<p><strong>NDEFæ•°æ®æ ¼å¼</strong>ï¼š</p>
<figure data-type="image" tabindex="2"><img src="https://i.loli.net/2019/03/02/5c7a185c4e7fc.png" alt="" loading="lazy"></figure>
<ol>
<li><strong>TNF</strong> 3bitsçš„å­—æ®µï¼Œæ ‡è¯†äº†å¦‚ä½•è§£æç¬¬äºŒä¸ªå­—æ®µtypeã€‚åŒ…å«çš„å€¼è§è¡¨ä¸€ï¼š</li>
</ol>
<p>è¡¨ä¸€ï¼ŒTNFå­—æ®µä»¥åŠæ˜ å°„ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">TNF</th>
<th>æ˜ å°„çš„Intent</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">TNF_ABSOLUTE_URI</td>
<td>åŸºäº<em>type</em>çš„URI</td>
</tr>
<tr>
<td style="text-align:left">TNF_EMPTY</td>
<td>æ— æ˜ å°„ï¼Œé™çº§åˆ°<code>ACTION_TECH_DISCOVERED</code></td>
</tr>
<tr>
<td style="text-align:left">TNF_EXTERNAL_TYPE</td>
<td>åŸºäº<em>type</em>çš„URI. typeå½¢å¼ä¸º <domain>:<service>ã€‚æ˜ å°„åçš„URIå½¢å¼ä¸ºï¼š <code>vnd.android.nfc://ext/&lt;domain&gt;:&lt;service&gt;</code>.</td>
</tr>
<tr>
<td style="text-align:left">TNF_MIME_MEDIA</td>
<td>åŸºäºtypeçš„MIMEç±»å‹</td>
</tr>
<tr>
<td style="text-align:left">TNF_UNCHANGED</td>
<td>æ— æ•ˆï¼Œé™çº§ä¸º<code>ACTION_TECH_DISCOVERED</code></td>
</tr>
<tr>
<td style="text-align:left">TNF_UNKNOWN</td>
<td>é™çº§ä¸º<code>ACTION_TECH_DISCOVERED</code></td>
</tr>
<tr>
<td style="text-align:left">TNF_WELL_KNOWN</td>
<td>åŸºäºtypeï¼ˆRTD)çš„MIME type or URIÂ ï¼Œéœ€è¦å†æ ¹æ®typeçš„å€¼è¿›è¡Œæ˜ å°„ï¼ˆè§è¡¨äºŒï¼‰</td>
</tr>
</tbody>
</table>
<p>è¡¨äºŒï¼ŒRTDs for TNF_WELL_KNOWNä»¥åŠæ˜ å°„ï¼š</p>
<table>
<thead>
<tr>
<th>RTD</th>
<th>æ˜ å°„çš„Intent</th>
</tr>
</thead>
<tbody>
<tr>
<td>RTD_ALTERNATIVE_CARRIER</td>
<td>é™çº§ä¸º<code>ACTION_TECH_DISCOVERED</code></td>
</tr>
<tr>
<td>RTD_HANDOVER_CARRIER</td>
<td>é™çº§ä¸º<code>ACTION_TECH_DISCOVERED</code></td>
</tr>
<tr>
<td>RTD_HANDOVER_REQUEST</td>
<td>é™çº§ä¸º<code>ACTION_TECH_DISCOVERED</code></td>
</tr>
<tr>
<td>RTD_HANDOVER_SELECT</td>
<td>é™çº§ä¸º<code>ACTION_TECH_DISCOVERED</code></td>
</tr>
<tr>
<td>RTD_SMART_POSTER</td>
<td>åŸºäºè§£æpayloadçš„URI</td>
</tr>
<tr>
<td>RTD_TEXT</td>
<td>MIMEç±»å‹ text/p</td>
</tr>
<tr>
<td>RTD_URI</td>
<td>åŸºäºpayloaddçš„URI</td>
</tr>
</tbody>
</table>
<ol start="2">
<li><strong>type</strong>,æè¿°Recordçš„ç±»å‹ï¼Œå¦‚æœTNFä¸ºTNF_WELL_KNOWNï¼Œåˆ™è¿™ä¸ªå­—æ®µæŒ‡å®šRTDï¼Œè§ä¸Šè¡¨äºŒã€‚</li>
<li><strong>ID</strong>ï¼Œå­—æ®µçš„å”¯ä¸€æ ‡è¯†ï¼Œä¸€èˆ¬ä¸å¸¸ç”¨ï¼Œå¯ä»¥ç”¨æ¥æ ‡è¯†ä¸€å¼ æ ‡ç­¾ã€‚</li>
<li><strong>payload</strong>ï¼Œæœ‰æ•ˆè·è½½ï¼Œä¿å­˜çœŸå®çš„æ•°æ®ã€‚</li>
</ol>
<p><strong>åˆ›å»ºå„ç§ç±»å‹çš„NDEFæ•°æ®&amp;å“åº”å¯¹åº”NDEF æ•°æ®çš„IntentFilterå®ä¾‹</strong></p>
<ol>
<li>åˆ›å»ºTNF_ABSOLUTE_URIç±»å‹æ•°æ®:</li>
</ol>
</li>
</ul>
<pre><code class="language-java">	NdefRecord uriRecord = new NdefRecord(
    NdefRecord.TNF_ABSOLUTE_URI ,
    &quot;http://developer.android.com/index.html&quot;.getBytes(Charset.forName(&quot;US-ASCII&quot;)),
    new byte[0], new byte[0]);
</code></pre>
<p>â€‹	å“åº”çš„intent filterï¼š</p>
<pre><code class="language-xml">&lt;intent-filter&gt;
    &lt;action android:name=&quot;android.nfc.action.NDEF_DISCOVERED&quot; /&gt;
    &lt;category android:name=&quot;android.intent.category.DEFAULT&quot; /&gt;
    &lt;data android:scheme=&quot;http&quot;
        android:host=&quot;developer.android.com&quot;
        android:pathPrefix=&quot;/index.html&quot; /&gt;
&lt;/intent-filter&gt;
</code></pre>
<p>â€‹	2. åˆ›å»ºTNF_MIME_MEDIAç±»å‹çš„æ•°æ®ï¼š</p>
<pre><code class="language-java">  NdefRecord mimeRecord = NdefRecord.createMime(&quot;application/vnd.com.example.android.beam&quot;,
      &quot;Beam me up, Android&quot;.getBytes(Charset.forName(&quot;US-ASCII&quot;)));
</code></pre>
<pre><code>å¯¹åº”çš„intent filter:
</code></pre>
<pre><code class="language-xml">  &lt;intent-filter&gt;
      &lt;action android:name=&quot;android.nfc.action.NDEF_DISCOVERED&quot; /&gt;
      &lt;category android:name=&quot;android.intent.category.DEFAULT&quot; /&gt;
      &lt;data android:mimeType=&quot;application/vnd.com.example.android.beam&quot; /&gt;
  &lt;/intent-filter&gt;
</code></pre>
<p>â€‹	3. åˆ›å»ºTNF_EXTERNAL_TYPEç±»å‹çš„æ•°æ®:</p>
<pre><code class="language-java">  byte[] payload; //assign to your data
  String domain = &quot;com.example&quot;; //usually your app's package name
  String type = &quot;externalType&quot;;
  NdefRecord extRecord = NdefRecord.createExternal(domain, type, payload);
</code></pre>
<pre><code>å¯¹åº”çš„intent filter:
</code></pre>
<pre><code class="language-xml">  &lt;intent-filter&gt;
      &lt;action android:name=&quot;android.nfc.action.NDEF_DISCOVERED&quot; /&gt;
      &lt;category android:name=&quot;android.intent.category.DEFAULT&quot; /&gt;
      &lt;data android:scheme=&quot;vnd.android.nfc&quot;
          android:host=&quot;ext&quot;
          android:pathPrefix=&quot;/com.example:externalType&quot;/&gt;
  &lt;/intent-filter&gt;
</code></pre>
<p>â€‹	4. åˆ›å»ºTNF_WELL_KNOWN with RTD_TEXTç±»å‹çš„æ•°æ®ï¼š</p>
<pre><code class="language-java">public NdefRecord createTextRecord(String payload, Locale locale, boolean encodeInUtf8) {
    byte[] langBytes = locale.getLanguage().getBytes(Charset.forName(&quot;US-ASCII&quot;));
    Charset utfEncoding = encodeInUtf8 ? Charset.forName(&quot;UTF-8&quot;) : Charset.forName(&quot;UTF-16&quot;);
    byte[] textBytes = payload.getBytes(utfEncoding);
    int utfBit = encodeInUtf8 ? 0 : (1 &lt;&lt; 7);
    char status = (char) (utfBit + langBytes.length);
    byte[] data = new byte[1 + langBytes.length + textBytes.length];
    data[0] = (byte) status;
    System.arraycopy(langBytes, 0, data, 1, langBytes.length);
    System.arraycopy(textBytes, 0, data, 1 + langBytes.length, textBytes.length);
    NdefRecord record = new NdefRecord(NdefRecord.TNF_WELL_KNOWN,
    NdefRecord.RTD_TEXT, new byte[0], data);
    return record;
}
</code></pre>
<p>â€‹	å¯¹åº”çš„Intent filter:</p>
<pre><code class="language-xml">&lt;intent-filter&gt;
    &lt;action android:name=&quot;android.nfc.action.NDEF_DISCOVERED&quot; /&gt;
    &lt;category android:name=&quot;android.intent.category.DEFAULT&quot; /&gt;
    &lt;data android:mimeType=&quot;text/plain&quot; /&gt;
&lt;/intent-filter&gt;

</code></pre>
<p>â€‹</p>
<p>â€‹	<strong>è¯»å†™NDEFæ ¼å¼çš„NFCæ•°æ®</strong>ï¼š</p>
<p>â€‹	1. Intentä¸­åŒ…å«ä¸‰ä¸ªç›¸å…³çš„æ•°æ®ï¼š</p>
<p>â€‹	<strong>EXTRA_TAG</strong> æ‰«æåˆ°çš„æ ‡ç­¾å¯¹è±¡</p>
<p>â€‹	<strong>EXTRA_NDEF_MESSAGES</strong> ä»æ ‡ç­¾ä¸­è·å–åˆ°çš„NDEFæ•°æ®å¯¹è±¡ï¼Œåªæœ‰ACTION_NDEF_DISCOVEREDç±»å‹çš„				IntentåŒ…å«</p>
<p>â€‹	<strong>EXTRA_ID</strong> æ ‡ç­¾çš„IDï¼ˆå¯é€‰ï¼‰</p>
<p>â€‹	2 .è§£æNDEFæ•°æ®çš„ä»£ç ä¸€èˆ¬ä¸ºï¼š</p>
<pre><code class="language-java">@Override
protected void onNewIntent(Intent intent) {
    super.onNewIntent(intent);
    ...
    if (intent != null &amp;&amp; NfcAdapter.ACTION_NDEF_DISCOVERED.equals(intent.getAction())) {
        Parcelable[] rawMessages =
            intent.getParcelableArrayExtra(NfcAdapter.EXTRA_NDEF_MESSAGES);
        if (rawMessages != null) {
            NdefMessage[] messages = new NdefMessage[rawMessages.length];
            for (int i = 0; i &lt; rawMessages.length; i++) {
                messages[i] = (NdefMessage) rawMessages[i];
            }
            // Process the messages array.
            ...
        }
    }
}
</code></pre>
<p>â€‹	å†™NDEFæ•°æ®çš„ä»£ç ä¸€èˆ¬ä¸ºï¼š</p>
<pre><code class="language-java"> @Override
    protected void onNewIntent(Intent intent) {
        super.onNewIntent(intent);
        Tag tag = intent.getParcelableExtra(NfcAdapter.EXTRA_TAG);
        NdefRecord ndefRecord = NdefRecord.createExternal(&quot;domain&quot;, &quot;service&quot;, &quot;content&quot;.getBytes());
        NdefMessage ndefMessage = new NdefMessage(new NdefRecord[] {ndefRecord});
        Ndef ndef = Ndef.get(tag); //è·å–Ndef techçš„å¯¹è±¡
        if (ndef != null) { //éNDEFæ•°æ®
            try {
                ndef.connect();
                ndef.writeNdefMessage(ndefMessage);
            } catch (IOException e) {
                e.printStackTrace();
            } catch (FormatException e) {
                e.printStackTrace();
            }
        } else { //å¯æ ¼å¼åŒ–ä¸ºNDEFæ•°æ®
            NdefFormatable ndefFormatable = NdefFormatable.get(tag);
            if (ndefFormatable != null) {
                try {
                    ndefFormatable.connect();
                    ndefFormatable.format(ndefMessage);
                } catch (IOException e) {
                    e.printStackTrace();
                } catch (FormatException e) {
                    e.printStackTrace();
                }
            }
        }
    }
</code></pre>
<p>â€‹</p>
<ul>
<li>
<p><strong>éNDEFæ•°æ®</strong>å¯ä»¥é…åˆ<strong>android.nfc.tech</strong>åŒ…ä¸‹çš„å¯¹åº”çš„ç±»æ¥è¿›è¡Œä½¿ç”¨ã€‚</p>
<p>æ¯ä¸ªNFCæ ‡ç­¾å¯èƒ½æ”¯æŒä¸åŒç§ç±»çš„<strong>technologies</strong>(ä¸åŒæ ¼å¼æ•°æ®çš„è¯»å†™ï¼‰ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹ä»£ç è·å–æ ‡ç­¾æ”¯æŒçš„<strong>techonologies</strong>:</p>
</li>
</ul>
<pre><code class="language-java">  mTag = getIntent().getParcelableExtra(NfcAdapter.EXTRA_TAG);
  String[] teches = mTag.getTechList();
</code></pre>
<p>Androidæ”¯æŒçš„å¸¸è§Technologyå¦‚ä¸‹è¡¨ï¼š</p>
<table>
<thead>
<tr>
<th>Class</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>TagTechnology</code></td>
<td>The interface that all tag technology classes must implement.</td>
</tr>
<tr>
<td><code>NfcA</code></td>
<td>Provides access to NFC-A (ISO 14443-3A) properties and I/O operations.</td>
</tr>
<tr>
<td><code>NfcB</code></td>
<td>Provides access to NFC-B (ISO 14443-3B) properties and I/O operations.</td>
</tr>
<tr>
<td><code>NfcF</code></td>
<td>Provides access to NFC-F (JIS 6319-4) properties and I/O operations.</td>
</tr>
<tr>
<td><code>NfcV</code></td>
<td>Provides access to NFC-V (ISO 15693) properties and I/O operations.</td>
</tr>
<tr>
<td><code>IsoDep</code></td>
<td>Provides access to ISO-DEP (ISO 14443-4) properties and I/O operations.</td>
</tr>
<tr>
<td><code>Ndef</code></td>
<td>Provides access to NDEF data and operations on NFC tags that have been formatted as NDEF.</td>
</tr>
<tr>
<td><code>NdefFormatable</code></td>
<td>Provides a format operations for tags that may be NDEF formattable.</td>
</tr>
</tbody>
</table>
<p>Androidè®¾å¤‡å¯é€‰æ”¯æŒçš„Technologyï¼š</p>
<table>
<thead>
<tr>
<th>Class</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>MifareClassic</code></td>
<td>Provides access to MIFARE Classic properties and I/O operations, if this Android device supports MIFARE.</td>
</tr>
<tr>
<td><code>MifareUltralight</code></td>
<td>Provides access to MIFARE Ultralight properties and I/O operations, if this Android device supports MIFARE.</td>
</tr>
</tbody>
</table>
<p>å‰é¢è®²è§£è¿‡ï¼Œæ ‡ç­¾åœ¨æŸäº›æƒ…å†µä¸‹ä¼šé™çº§ä¸º<code>ACTION_TECH_DISCOVERED</code>ç±»å‹çš„Intentï¼Œå¯¹åº”çš„xmlæ–‡ä»¶ä¸º:</p>
<pre><code class="language-xml">&lt;activity&gt;
...
&lt;intent-filter&gt;
    &lt;action android:name=&quot;android.nfc.action.TECH_DISCOVERED&quot;/&gt;
&lt;/intent-filter&gt;

&lt;meta-data android:name=&quot;android.nfc.action.TECH_DISCOVERED&quot;
    android:resource=&quot;@xml/nfc_tech_filter&quot; /&gt;
...
&lt;/activity&gt;
</code></pre>
<p>å…¶ä¸­**android:resource=&quot;@xml/nfc_tech_filter&quot;**æŒ‡å®šNFC technologyçš„è¿‡æ»¤æ–‡ä»¶ï¼Œæ”¾åœ¨<code>res/xml</code>ç›®å½•ä¸‹ä»»æ„å‘½åã€‚å…¶ä¸­æŒ‡å®šçš„technologieså¿…é¡»æ˜¯æ‰€è¯†åˆ«çš„æ ‡ç­¾æ”¯æŒçš„technologiesçš„å­é›†ï¼Œæ‰èƒ½åŒ¹é…åˆ°ã€‚ä¾‹å¦‚ï¼š</p>
<pre><code class="language-xml">&lt;resources xmlns:xliff=&quot;urn:oasis:names:tc:xliff:document:1.2&quot;&gt;
    &lt;tech-list&gt;
        &lt;tech&gt;android.nfc.tech.IsoDep&lt;/tech&gt;
        &lt;tech&gt;android.nfc.tech.NfcA&lt;/tech&gt;
        &lt;tech&gt;android.nfc.tech.NfcB&lt;/tech&gt;
        &lt;tech&gt;android.nfc.tech.NfcF&lt;/tech&gt;
        &lt;tech&gt;android.nfc.tech.NfcV&lt;/tech&gt;
        &lt;tech&gt;android.nfc.tech.Ndef&lt;/tech&gt;
        &lt;tech&gt;android.nfc.tech.NdefFormatable&lt;/tech&gt;
        &lt;tech&gt;android.nfc.tech.MifareClassic&lt;/tech&gt;
        &lt;tech&gt;android.nfc.tech.MifareUltralight&lt;/tech&gt;
    &lt;/tech-list&gt;
&lt;/resources&gt;
</code></pre>
<p>æˆ–è€…åˆ†å¼€å¤šä¸ª**<tech-list>**,ä»–ä»¬ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼ŒåŒ¹é…ä¸€ä¸ªå°±å¥½ã€‚</p>
<pre><code class="language-xml">&lt;resources xmlns:xliff=&quot;urn:oasis:names:tc:xliff:document:1.2&quot;&gt;
    &lt;tech-list&gt;
        &lt;tech&gt;android.nfc.tech.NfcA&lt;/tech&gt;
        &lt;tech&gt;android.nfc.tech.Ndef&lt;/tech&gt;
    &lt;/tech-list&gt;
&lt;/resources&gt;

&lt;resources xmlns:xliff=&quot;urn:oasis:names:tc:xliff:document:1.2&quot;&gt;
    &lt;tech-list&gt;
        &lt;tech&gt;android.nfc.tech.NfcB&lt;/tech&gt;
        &lt;tech&gt;android.nfc.tech.Ndef&lt;/tech&gt;
    &lt;/tech-list&gt;
&lt;/resources&gt;
</code></pre>
<p><strong>å„ç§ç±»å‹çš„éNDEFæ•°æ®æ ¼å¼çš„è¯»å†™</strong></p>
<p>æŸ¥çœ‹å¯¹åº”çš„è§„æ ¼ä¹¦æŒ‰ç…§åè®®æ¥ä½¿ç”¨ï¼Œåœ¨developer.android.comä¸­å¯ä»¥ç®€å•åœ°æŸ¥çœ‹ä¸€ç§æ•°æ®æ ¼å¼çš„è¯´æ˜ï¼šå¦‚ <a href="https://developer.android.com/reference/android/nfc/tech/MifareClassic.html">MIFAREClassic</a></p>
<h2 id="p2p-mode">P2P mode</h2>
<p>å³AndroidBeamåŠŸèƒ½ï¼Œä½¿ä¸¤å°Androidè®¾å¤‡è¿›è¡Œå¿«é€Ÿçš„æ•°æ®äº¤æ¢ã€‚å‘é€æ•°æ®çš„è®¾å¤‡æ‰“å¼€å‘é€æ•°æ®çš„åº”ç”¨ï¼ˆç›¸å½“äºä¸€å¼ æ ‡ç­¾ï¼‰ï¼Œæ¥å—æ•°æ®çš„è®¾å¤‡è§£é”é è¿‘å‘é€æ•°æ®çš„è®¾å¤‡ä¹‹åï¼Œå‘é€æ•°æ®çš„è®¾å¤‡UIæ˜¾ç¤ºâ€œTouch to Beam&quot;,ç‚¹å‡»å³å¯å°†æ•°æ®å‘é€ç»™æ¥æ”¶ç«¯ï¼ˆæ¥æ”¶ç«¯è®¾å¤‡æ¥å—åˆ°æ•°æ®é€šè¿‡æ ‡ç­¾åˆ†å‘ç³»ç»Ÿå†³å®šæ‰“å¼€çš„åº”ç”¨è¿›è¡Œå¤„ç†ï¼‰ã€‚</p>
<p>ç›¸å…³çš„APIæœ‰ä¸¤ä¸ªï¼š</p>
<p><strong>NfcAdapter.setNdefPushMessage()</strong> :å‘é€ç«¯è®¾ç½®è¦å‘é€çš„NDEFæ•°æ®ã€‚ä¸¤å°è®¾å¤‡é è¿‘ä¹‹åç‚¹å‡»â€Touch to Beam&quot;å‘é€æ­¤æ•°æ®ã€‚</p>
<p><strong>NfcAdapter.setNdefPushMessageCallback()</strong>:æ­¤æ–¹æ³•æ¥å—ä¸€ä¸ª<strong>NfcAdapter.CreateNdefMessageCallback</strong>ç±»å‹çš„å›è°ƒæ¥å£ï¼Œæ­¤æ¥å£åœ¨ä¸¤å°è®¾å¤‡é è¿‘æ—¶å›è°ƒè¿›è¡ŒNDEFæ•°æ®çš„åˆ›å»ºï¼Œç„¶åç‚¹å‡»â€œTouch to Beam&quot;å‘é€æ•°æ®ã€‚</p>
<p>ä¸¤ä¸ªæ¥å£çš„å”¯ä¸€ä¸åŒåœ¨äºï¼šæ¥å£1ä¸€å¼€å§‹ä¾¿ç¡®å®šäº†è¦å‘é€çš„æ•°æ®ï¼›æ¥å£2åœ¨ä¸¤ä¸ªè®¾å¤‡é è¿‘æ—¶æ‰åˆ›å»ºè¦å‘é€çš„NDEFæ•°æ®ã€‚</p>
<p><em>ä»£ç ç¤ºä¾‹</em>(Demoä¸­onCreateä¸­ä¸ºå‘é€ç«¯é€»è¾‘ï¼ŒonResumeä¸­ä¸ºæ¥æ”¶ç«¯å¤„ç†é€»è¾‘):</p>
<pre><code class="language-java">public class MainActivity extends AppCompatActivity {

    private NfcAdapter mNfcAdapter;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        mNfcAdapter = NfcAdapter.getDefaultAdapter(this);
        if (mNfcAdapter == null) {
            Toast.makeText(this, &quot;not support nfc&quot;, Toast.LENGTH_SHORT).show();
            finish();
            return;
        }

        final NdefRecord ndefRecord = 		 NdefRecord.createMime(&quot;application/vnd.com.example.android.beam&quot;, &quot;hello android&quot;.getBytes());
        mNfcAdapter.setNdefPushMessageCallback(new NfcAdapter.CreateNdefMessageCallback() {
            @Override
            public NdefMessage createNdefMessage(NfcEvent nfcEvent) {
                Log.v(&quot;seewo&quot;, &quot;createNdefMessage&quot;);
                return new NdefMessage(ndefRecord);
            }
        }, this);
//        mNfcAdapter.setNdefPushMessage(new NdefMessage(ndefRecord), this); //æ¥å£ä¸€çš„å®ç°
    }

    @Override
    protected void onResume() {
        super.onResume();
        //æ¥æ”¶ç«¯çš„å¤„ç†é€»è¾‘
        if (NfcAdapter.ACTION_NDEF_DISCOVERED.equals(getIntent().getAction())) {
            processIntent(getIntent());
        }
    }

    @Override
    public void onNewIntent(Intent intent) {
        setIntent(intent);
    }

    void processIntent(Intent intent) {
        Parcelable[] rawMessages = 		     intent.getParcelableArrayExtra(NfcAdapter.EXTRA_NDEF_MESSAGES);
        NdefMessage msg = (NdefMessage) rawMessages[0];
        String info = new String(msg.getRecords()[0].getPayload());
        Toast.makeText(this, info, Toast.LENGTH_SHORT).show();
    }
}

</code></pre>
<h2 id="card-emulation-mode">Card emulation mode</h2>
<p>Android4.4ä¹‹å‰é€šè¿‡åœ¨Androidè®¾å¤‡ä¸­å†…ç½®ä¸€ä¸ªèŠ¯ç‰‡æ¥å®ç°ã€‚é€šä¿¡è·¯å¾„å¦‚ä¸‹å›¾ï¼š</p>
<figure data-type="image" tabindex="3"><img src="https://i.loli.net/2019/03/02/5c7a1893b60b8.png" alt="" loading="lazy"></figure>
<p>Android4.4ä¹‹åå¯ä»¥é€šè¿‡çº¯è½¯ä»¶æ¨¡æ‹ŸNFCå¡ã€‚é€šä¿¡è·¯å¾„å¦‚ä¸‹å›¾ï¼š</p>
<figure data-type="image" tabindex="4"><img src="https://i.loli.net/2019/03/02/5c7a189e94ec6.png" alt="" loading="lazy"></figure>
<p>åœ¨Androidä¸Šå±‚ç¨‹åºåªéœ€å®ç°ä¸€ä¸ªæœåŠ¡ï¼Œå¹¶ä¸”ç»™æœåŠ¡ç»‘å®šä¸€ä¸ªIDï¼Œä¾¿å¯ä»¥æ¨¡æ‹ŸæˆNFCå¡ï¼Œæ ¹æ®è¯»å¡å™¨å‘å‡ºçš„IDå“åº”æ•°æ®ã€‚</p>
<pre><code class="language-java">public class MyHostApduService extends HostApduService {
    @Override
    public byte[] processCommandApdu(byte[] apdu, Bundle extras) {
       ...
    }
    @Override
    public void onDeactivated(int reason) {
       ...
    }
}
</code></pre>
<pre><code class="language-xml">&lt;service android:name=&quot;.MyHostApduService&quot; android:exported=&quot;true&quot;
         android:permission=&quot;android.permission.BIND_NFC_SERVICE&quot;&gt;
    &lt;intent-filter&gt;
        &lt;action android:name=&quot;android.nfc.cardemulation.action.HOST_APDU_SERVICE&quot;/&gt;
    &lt;/intent-filter&gt;
    &lt;meta-data android:name=&quot;android.nfc.cardemulation.host_apdu_service&quot;
               android:resource=&quot;@xml/apduservice&quot;/&gt;
&lt;/service&gt;
</code></pre>
<pre><code class="language-xml">&lt;host-apdu-service xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
           android:description=&quot;@string/servicedesc&quot;
           android:requireDeviceUnlock=&quot;false&quot;&gt;
    &lt;aid-group android:description=&quot;@string/aiddescription&quot;
               android:category=&quot;other&quot;&gt;
        &lt;aid-filter android:name=&quot;F0010203040506&quot;/&gt;
        &lt;aid-filter android:name=&quot;F0394148148100&quot;/&gt;
    &lt;/aid-group&gt;
&lt;/host-apdu-service&gt;
</code></pre>
<hr>
<h2 id="ç›¸å…³èµ„æ–™">ç›¸å…³èµ„æ–™</h2>
<p>1.NDEFæ•°æ®è§£æå®ä¾‹ï¼š<a href="http://note.youdao.com/share/?id=8b45d342e34d2bce0fade2218bafd79c&amp;type=note">http</a><a href="http://note.youdao.com/share/?id=8b45d342e34d2bce0fade2218bafd79c&amp;type=note">ğŸ˜•/note.youdao.com/share/?id=8b45d342e34d2bce0fade2218bafd79c&amp;type=note#</a><a href="http://note.youdao.com/share/?id=8b45d342e34d2bce0fade2218bafd79c&amp;type=note">/</a></p>
<p>2.AndnroidNFCå®˜ç½‘ä»‹ç»ï¼š<a href="https://developer.android.com/guide/topics/connectivity/nfc/index.html">https</a><a href="https://developer.android.com/guide/topics/connectivity/nfc/index.html">ğŸ˜•/</a><a href="https://developer.android.com/guide/topics/connectivity/nfc/index.html">developer.android.com/guide/topics/connectivity/nfc/index.html</a></p>
<p>3.NFCç›¸å…³çš„åº”ç”¨ï¼šNXPTagWriterã€NXPTagInfoã€MIFAREç»å…¸å·¥å…·</p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://monkeylmj.github.io/tag/nfc" class="tag">
                    NFC
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://monkeylmj.github.io/post/handler">
                  <h3 class="post-title">
                    Androidçš„æ¶ˆæ¯æœºåˆ¶-Handler
                  </h3>
                </a>
              </div>
            

            
              
                <div id="gitalk-container" data-aos="fade-in"></div>
              

              
            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>

<script type="application/javascript">

AOS.init();

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>



  
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>

      var gitalk = new Gitalk({
        clientID: 'e9cdf34c05a98e6b38aa',
        clientSecret: '5575ef73b184711f05560b414b117640a727edf7',
        repo: 'monkeylmj.github.io',
        owner: 'monkeylmj',
        admin: ['monkeylmj'],
        id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
        distractionFreeMode: false  // Facebook-like distraction free mode
      })

      gitalk.render('gitalk-container')

    </script>
  

  




  </body>
</html>
